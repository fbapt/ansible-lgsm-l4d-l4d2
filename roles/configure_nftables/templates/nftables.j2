#!/usr/sbin/nft -f
flush ruleset

define ssh_port = {{ configure_nftables_ssh_port }}
define games_ports = { {{ configure_nftables_games_servers_ports }} }

table inet filter {

    set ssh_recent {
        type ipv4_addr
        timeout 60s
        flags timeout
    }

    set lgsm_recent {
        type ipv4_addr
        timeout 60s
        flags timeout
    }

    chain ssh_bruteforce {
        ip saddr @ssh_recent limit rate over 30/minute drop
        add @ssh_recent { ip saddr }
        return
    }

    chain lgsm_bruteforce {
        ip saddr @lgsm_recent limit rate over 15/minute drop
        add @lgsm_recent { ip saddr }
        return
    }

    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback
        iif "lo" accept

        # Connexions Ã©tablies
        ct state established,related accept

        # Paquets invalides
        ct state invalid drop

        # SSH
        tcp dport $ssh_port ct state new jump ssh_bruteforce
        tcp dport $ssh_port ct state new accept

        # GAME SERVERS UDP
        udp dport $games_ports ct state new jump lgsm_bruteforce
        udp dport $games_ports ct state new accept
        udp dport $games_ports ct state established accept

        # TCP scan protection
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) drop
        tcp flags & (fin|syn|rst|psh|ack|urg) == (fin|syn|rst|psh|ack|urg) drop
        tcp flags & (syn|rst) == (syn|rst) drop
        tcp flags & (syn|fin) == (syn|fin) drop

        # SYN flood protection
        tcp flags syn limit rate 50/second burst 200 packets accept
        tcp flags syn drop

        # ICMP minimal safe
        ip protocol icmp icmp type echo-request limit rate 1/second accept
        ip protocol icmp icmp type echo-request drop
        ip protocol icmp icmp type {
            destination-unreachable,
            time-exceeded,
            parameter-problem
        } accept

        # IPv6
        ip6 nexthdr ipv6-icmp icmpv6 type {
            destination-unreachable,
            packet-too-big,
            time-exceeded,
            parameter-problem,
            nd-router-solicit,
            nd-router-advert,
            nd-neighbor-solicit,
            nd-neighbor-advert
        } accept

        ip6 nexthdr ipv6-icmp drop
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }
}
