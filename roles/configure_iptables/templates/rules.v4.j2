*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Loopback
-A INPUT -i lo -j ACCEPT

# Connexions etablies
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Paquets invalides
-A INPUT -m conntrack --ctstate INVALID -j DROP

# Regle SSH suivi des tentatives
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -m recent --set --name SSH_ATT --rsource

# Détection SSH bruteforce
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 10 --name SSH_ATT --rsource -j DROP

# Limite normale SSH
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} -m conntrack --ctstate NEW -m limit --limit 20/min --limit-burst 20 -j ACCEPT

# Log limite avant drop
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} -m limit --limit 2/min --limit-burst 4 -j LOG --log-prefix "SSH brute attempt: " --log-level 7

# Drop final SSH
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} -m conntrack --ctstate NEW -j DROP

# L4D1 L4D2
-A INPUT -p udp -m multiport --dports {{ configure_iptables_games_servers_ports }} -m conntrack --ctstate NEW,ESTABLISHED -m hashlimit --hashlimit-upto 80/second --hashlimit-burst 150 --hashlimit-mode srcip,dstport --hashlimit-name l4d_udp_limit -j ACCEPT
-A INPUT -p udp -m multiport --dports {{ configure_iptables_games_servers_ports }} -j DROP

# Blocage complet ICMP
-A INPUT -p icmp -j DROP

# Protection scans TCP
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP
-A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
-A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
-A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
-A INPUT -p tcp --tcp-flags ACK,FIN FIN -j DROP
-A INPUT -p tcp --tcp-flags ACK,PSH PSH -j DROP
-A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

# Protection SYN flood
-A INPUT -p tcp --syn -m limit --limit 50/second --limit-burst 200 -j ACCEPT

# Logging limite global
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables DROP: " --log-level 7

COMMIT

*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Priorité trafic UDP L4D1 L4D2
-A OUTPUT -p udp -m multiport --sports {{ configure_iptables_games_servers_ports }} -j TOS --set-tos 0x10

COMMIT
