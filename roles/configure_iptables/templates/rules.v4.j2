{% set game_ports_list = configure_iptables_games_servers_ports.split(',') %}
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Loopback
-A INPUT -i lo -j ACCEPT

# Connexions établies
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Paquets invalides
-A INPUT -m conntrack --ctstate INVALID -j DROP

# SSH acceptation limitée (safe)
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -m limit --limit 20/min --limit-burst 20 -j ACCEPT
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -m limit --limit 2/min --limit-burst 4 -j LOG --log-prefix "SSH brute attempt: " --log-level 7
-A INPUT -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -j ACCEPT

# UDP Game servers - limitation par IP source + port (hashlimit)
{% for port in game_ports_list %}
-A INPUT -p udp --dport {{ port }} -m conntrack --ctstate NEW,ESTABLISHED -m hashlimit --hashlimit 80/second --hashlimit-burst 150 --hashlimit-mode srcip,dstport --hashlimit-name udp_{{ port }} -j ACCEPT
-A INPUT -p udp --dport {{ port }} -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
{% endfor %}

# TCP scan protection
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP
-A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
-A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
-A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
-A INPUT -p tcp --tcp-flags ACK,FIN FIN -j DROP
-A INPUT -p tcp --tcp-flags ACK,PSH PSH -j DROP
-A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

# SYN flood protection
-A INPUT -p tcp --syn -m limit --limit 50/second --limit-burst 200 -j ACCEPT

# ICMP minimal
-A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT
-A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT
-A INPUT -p icmp --icmp-type parameter-problem -j ACCEPT
-A INPUT -p icmp --icmp-type echo-request -j DROP

# Logging limité global
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables DROP: " --log-level 7

COMMIT

*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Priorité du trafic UDP en sortie (QoS)
{% for port in game_ports_list %}
-A OUTPUT -p udp --sport {{ port }} -j DSCP --set-dscp 0x10
{% endfor %}

COMMIT
