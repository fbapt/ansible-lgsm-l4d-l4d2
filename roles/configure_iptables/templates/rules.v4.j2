{% set game_ports_list = configure_iptables_games_servers_ports.split(',') %}
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Loopback
-A INPUT -i lo -j ACCEPT

# Connexions Ã©tablies
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Paquets invalides
-A INPUT -m conntrack --ctstate INVALID -j DROP

# SSH bruteforce protection
-A INPUT -i ! lo -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -m recent --set --name SSH --rsource
-A INPUT -i ! lo -p tcp --dport {{ configure_iptables_ssh_port }} --syn -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 30 --name SSH --rsource -j DROP
-A INPUT -i ! lo -p tcp --dport {{ configure_iptables_ssh_port }} -m conntrack --ctstate NEW -j ACCEPT

# UDP Game servers - rate-limit type LinuxGSM (recent)
{% for port in game_ports_list %}
-A INPUT -p udp --dport {{ port }} -m state --state NEW -m recent --set --name LGSM_RATE_{{ port }} --rsource
-A INPUT -p udp --dport {{ port }} -m state --state NEW -m recent --update --seconds 60 --hitcount 15 --name LGSM_RATE_{{ port }} --rsource -j DROP
{% endfor %}

# UDP Game servers - limitation par IP source + port (hashlimit)
{% for port in game_ports_list %}
-A INPUT -p udp --dport {{ port }} -m conntrack --ctstate NEW,ESTABLISHED -m hashlimit --hashlimit 80/second --hashlimit-burst 150 --hashlimit-mode srcip,dstport --hashlimit-name udp_{{ port }} -j ACCEPT
-A INPUT -p udp --dport {{ port }} -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
{% endfor %}

# TCP scan protection
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP
-A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
-A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP

# SYN flood protection
-A INPUT -p tcp --syn -m hashlimit --hashlimit-name syn_flood --hashlimit 50/second --hashlimit-burst 200 --hashlimit-mode srcip -j ACCEPT
-A INPUT -p tcp --syn -j DROP

# ICMP minimal safe
-A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/second -j ACCEPT
-A INPUT -p icmp --icmp-type echo-request -j DROP

COMMIT
